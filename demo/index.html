<!DOCTYPE html>
<html>
  <head>
    <title>Pocktails Todo Demo</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"></script>
    <script src="sdk/pathval.js"></script>
    <script src="sdk/sdk.js"></script>

    <style>
      body {
        font-family: sans-serif;
      }

      .todo span {
        display: inline-block;
        margin: 12px 8px;
      }
    </style>
  </head>

  <body>
    <h3> Todos </h3>

    <div class="todo-list">
      <input type="text" id="todo-input"/>
      <button id="add-todo-btn">Add Todo</button>
      <ul id="list"></ul>
    </div>

    <script>
      const pocktails = new Pocktails()

      class TodoList {
        constructor() {
          this.todoInput = document.querySelector('#todo-input')
          this.addTodoBtn = document.querySelector('#add-todo-btn')
          this.list = document.querySelector('#list')

          pocktails.addEventListener('handshake', this.rebuildTodosList.bind(this))
          pocktails.addEventListener('update', this.rebuildTodosList.bind(this))
          this.addTodoBtn.addEventListener('click', this.addTodo.bind(this))
          this.list.addEventListener('click', e => {
            if (e.target.classList.contains('delete-todo-btn'))
              this.deleteTodo(e)
            else if (e.target.classList.contains('edit-todo-btn'))
              this.editTodo(e)
          })
        }

        rebuildTodosList() {
          const list = document.querySelector('#list')
          const todosHTML = pocktails.models.todos.items.map(todo => {
            return `
              <li class="todo">
                <button
                  data-id="${todo.id}"
                  class="delete-todo-btn">
                  X
                </button>
                <button
                  data-id="${todo.id}"
                  class="edit-todo-btn">
                  Edit
                </button>
                <span>${todo.content}</span>
              </li>
            `.trim()
          })

          list.innerHTML = todosHTML.join('')
        }

        addTodo() {
          const content = this.todoInput.value

          if (!content.trim()) return alert('Todo must have content')

          pocktails.push('todos', 'items', {
            id: this.getUUID(),
            content
          })

          this.rebuildTodosList()
        }

        deleteTodo(e) {
          const id = e.target.getAttribute('data-id')
          const index = pocktails.models.todos.items.findIndex(todo => {
            return todo.id === id
          })

          pocktails.splice('todos', 'items', index, 1)
        }

        editTodo(e) {
          const id = e.target.getAttribute('data-id')
          const index = pocktails.models.todos.items.findIndex(todo => {
            return todo.id === id
          })

          pocktails.set('todos', `items.${index}.content`, prompt('Type new content'))
        }


        getUUID() {
          return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
            const r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8)

            return v.toString(16)
          })
        }
      }

      new TodoList()
    </script>
  </body>
</html>
